<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CGS Dynamic ‚Äî HF-based Triggers</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="shared.css">
<style>
.trigger-info {
  background: linear-gradient(135deg, #2a1a3a, #1a2a4a);
  border: 2px solid #9966ff;
  padding: 15px 20px;
  border-radius: 12px;
  margin: 15px 0;
  font-size: 0.9em;
}
.trigger-info h4 {
  color: #9966ff;
  margin-bottom: 10px;
}
.trigger-info ul {
  margin-left: 20px;
}
.trigger-info li {
  margin: 5px 0;
}
.trigger-info .highlight {
  color: #f7931a;
  font-weight: bold;
}
.table-wrap {
  overflow-x: auto;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #1a1a3a;
  border-radius: 8px;
  overflow: hidden;
  font-size: 0.7em;
}
th {
  background: #2d2d6a;
  color: #f7931a;
  padding: 6px 3px;
  text-align: center;
  font-weight: 600;
  white-space: nowrap;
}
td {
  padding: 5px 3px;
  text-align: center;
  border-bottom: 1px solid #333;
}
tr:nth-child(even) { background: #1e1e4a; }
tr:hover { background: #2a2a6a; }
tr.trigger-row { background: linear-gradient(90deg, #3a2a1a, #2a1a3a) !important; }
tr.trigger-row:hover { background: linear-gradient(90deg, #4a3a2a, #3a2a4a) !important; }
.action-cell {
  text-align: left !important;
  font-size: 0.85em;
  max-width: 220px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.positive { color: #00ff88; }
.warning { color: #ffaa00; }
.danger { color: #ff4444; }
.neutral { color: #888; }
.yield-inputs {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 15px 0;
  padding: 15px;
  background: #1a1a4a;
  border-radius: 8px;
}
.conclusions {
  background: linear-gradient(135deg, #1a2a3a, #2a3a4a);
  border: 2px solid #00d4aa44;
  border-radius: 12px;
  padding: 25px;
  margin: 30px 0;
}
.conclusions h2 {
  color: #00d4aa;
  margin-bottom: 20px;
}
.conclusions h4 {
  color: #f7931a;
  margin: 20px 0 10px 0;
}
.conclusions p {
  color: #ccc;
  line-height: 1.6;
}
.conclusions ul, .conclusions ol {
  margin-left: 20px;
  color: #aaa;
}
.conclusions li {
  margin: 8px 0;
  line-height: 1.5;
}
.conclusions li b {
  color: #fff;
}
</style>
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
<div class="password-box">
<h2>üîí Capital Growth Dynamic</h2>
<input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
<button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
<div class="error" id="passwordError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
</div>
</div>

<div class="container content-hidden" id="mainContent">
<h1>üìä Capital Growth Dynamic ‚Äî HF-based Triggers</h1>

<div class="disclaimer">
‚ö° –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç <b>—Ç–æ–ª—å–∫–æ –∑–∞—â–∏—Ç–Ω—É—é –º–µ—Ö–∞–Ω–∏–∫—É</b> –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Ä—ã–Ω–∫–∞.<br>
–ë–µ–∑ —É—á—ë—Ç–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ DeFi-–ø–æ–∑–∏—Ü–∏–π –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö DCA-–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.
</div>

<div class="trigger-info">
<h4>üéØ –õ–æ–≥–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (HF &lt; 1.45)</h4>
<ul>
<li>–ü—Ä–∏ <span class="highlight">HF &lt; 1.45</span>: CLMM –≤—ã—Ö–æ–¥–∏—Ç –ø–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ (-15%)</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #1:</b> CLMM#1 ‚Üí BTC –≤ –∑–∞–ª–æ–≥, Reserve ‚Üí –æ—Ç–∫—Ä—ã—Ç—å CLMM#2</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #2:</b> CLMM#2 ‚Üí BTC –≤ –∑–∞–ª–æ–≥ (–Ω–æ–≤—É—é –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º)</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #3:</b> –ü—Ä–æ–¥–∞—ë–º GM, 1/3 Stability + USDC ‚Üí –ø–æ–∫—É–ø–∫–∞ GM</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #4:</b> –ü—Ä–æ–¥–∞—ë–º GM, 1/2 Stability + USDC ‚Üí –ø–æ–∫—É–ø–∫–∞ GM</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #5:</b> –ü—Ä–æ–¥–∞—ë–º GM, –≤—Å—è Stability + USDC ‚Üí –ø–æ–∫—É–ø–∫–∞ GM</li>
<li><b>–¢—Ä–∏–≥–≥–µ—Ä #6+:</b> –¢–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞—ë–º GM</li>
</ul>
</div>

<h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
<div class="params-table">
<table class="input-table">
<tr>
<td><label>–û–±—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å ($)</label><input type="number" id="totalPortfolio" value="100000"></td>
<td><label>–¶–µ–Ω–∞ BTC ($)</label><input type="number" id="btcPrice" value="100000"></td>
</tr>
<tr>
<td><label>Initial LTV (%)</label><input type="number" id="initLTV" value="50"></td>
<td><label>Liq Threshold (%)</label><input type="number" id="liqThreshold" value="85"></td>
</tr>
<tr>
<td><label>HF Trigger (–Ω–∏–∂–µ)</label><input type="number" id="hfTrigger" value="1.45" step="0.05"></td>
<td><label>HF Target (–ø–æ–¥–Ω—è—Ç—å –¥–æ)</label><input type="number" id="hfTarget" value="1.7" step="0.1"></td>
</tr>
</table>

<div class="slider-group">
<div class="slider-header">
<span>Growth Zone: <b id="growthVal">60%</b></span>
<span>Stability Zone: <b id="stabilityVal">40%</b></span>
</div>
<input type="range" id="growthSlider" min="0" max="100" value="40">
<div class="slider-labels"><span>0%</span><span>50%</span><span>100%</span></div>
</div>

<div style="color:#00d4aa;font-size:0.95em;margin:15px 0">Yield Zone (% –æ—Ç –∑–∞–π–º–∞):</div>
<div class="yield-inputs">
<div class="yield-input">
<label for="gmPct">GM Pool %</label>
<input type="number" id="gmPct" value="40" min="0" max="100">
</div>
<div class="yield-input">
<label for="clmmPct">CLMM %</label>
<input type="number" id="clmmPct" value="30" min="0" max="100">
</div>
<div class="yield-input">
<label for="reservePct">Reserve %</label>
<input type="number" id="reservePct" value="30" min="0" max="100">
</div>
</div>
<div class="yield-total" id="yieldTotal">–°—É–º–º–∞: 100% ‚úì</div>
<div style="color:#888;font-size:0.85em;margin-top:10px">CLMM –¥–∏–∞–ø–∞–∑–æ–Ω: -15% / +5% –æ—Ç —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∏—è</div>
</div>

<button id="runBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é</button>

<h2>üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (—à–∞–≥ -2% –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ü–µ–Ω—ã)</h2>
<div class="table-wrap">
<table id="resultsTable">
<thead><tr>
<th>Drop (init)</th><th>Drop (last)</th><th>Drop (trig)</th><th>BTC $</th>
<th>HF –¥–æ</th><th>HF –ø–æ—Å–ª–µ</th>
<th>LTV %</th><th>Collateral BTC</th>
<th>GM $</th><th>CLMM $</th><th>CLMM#</th>
<th>Reserve $</th><th>Stability $</th>
<th>BTC +</th>
<th>Y/L</th>
<th>–î–µ–π—Å—Ç–≤–∏–µ</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>üìù –õ–æ–≥ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤</h2>
<div class="log" id="logContainer"></div>

<h2>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h2>
<div class="charts">
<div class="chart-box"><canvas id="hfChart"></canvas></div>
<div class="chart-box"><canvas id="ltvChart"></canvas></div>
<div class="chart-box"><canvas id="collateralChart"></canvas></div>
<div class="chart-box"><canvas id="yieldChart"></canvas></div>
</div>

<div class="summary" id="summary"></div>

<div class="conclusions">
<h2>üìù –í—ã–≤–æ–¥—ã</h2>

<h4>–ü–æ—á–µ–º—É —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ Health Factor –ª—É—á—à–µ?</h4>
<p>
–¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ HF –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã, —Ç–∞–∫ –∫–∞–∫ —É—á–∏—Ç—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
</p>
<ul>
<li><b>–£—á–∏—Ç—ã–≤–∞—é—Ç –¥–æ—Ö–æ–¥—ã —Å DeFi</b> ‚Äî –ø—Ä–∏–±—ã–ª—å –æ—Ç CLMM/GM —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∑–∞–ª–æ–≥</li>
<li><b>–û–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞</b> ‚Äî HF –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –ø–æ–∑–∏—Ü–∏–∏, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç "–ø—Ä–æ—Å–∞–¥–∫–∏ BTC", –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –æ—Ç–∫—É–¥–∞ –æ—Ç—Å—á–∏—Ç—ã–≤–∞—Ç—å</li>
<li><b>–£—á–∏—Ç—ã–≤–∞—é—Ç DCA</b> ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–æ–¥–≤–∏–≥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã</li>
</ul>

<h4>–õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è DCA</h4>
<p>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ DCA-–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:</p>
<ol>
<li><b>Stability Zone</b> ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏—é Growth/Stability</li>
<li><b>Yield Zone</b> ‚Äî –µ—Å–ª–∏ Yield Zone –º–∞–ª–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–æ–ª–≥–æ–º</li>
<li><b>Growth Zone</b> ‚Äî –µ—Å–ª–∏ –≤—Å—ë –≤ –Ω–æ—Ä–º–µ, DCA –∏–¥—ë—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É BTC ‚Üí –≤ –∑–∞–ª–æ–≥ ‚Üí –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –∑–∞–π–º</li>
</ol>
</div>

<div class="version">Dynamic v1.0</div>
</div>

<script src="shared.js"></script>
<script>

document.getElementById('growthSlider').addEventListener('input', function(e) {
  document.getElementById('growthVal').textContent = (100 - e.target.value) + '%';
  document.getElementById('stabilityVal').textContent = e.target.value + '%';
});

['gmPct', 'clmmPct', 'reservePct'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateYieldTotal);
});

function updateYieldTotal() {
  const gm = +document.getElementById('gmPct').value || 0;
  const clmm = +document.getElementById('clmmPct').value || 0;
  const res = +document.getElementById('reservePct').value || 0;
  const total = gm + clmm + res;
  const el = document.getElementById('yieldTotal');
  el.textContent = '–°—É–º–º–∞: ' + total + '% ' + (total === 100 ? '‚úì' : '‚úó');
  el.className = 'yield-total ' + (total === 100 ? 'valid' : 'invalid');
}

document.getElementById('runBtn').addEventListener('click', runSimulation);

function onAuthSuccess() {
  runSimulation();
}

function runSimulation() {
  const gmPctVal = +document.getElementById('gmPct').value || 0;
  const clmmPctVal = +document.getElementById('clmmPct').value || 0;
  const reservePctVal = +document.getElementById('reservePct').value || 0;
  const yieldTotal = gmPctVal + clmmPctVal + reservePctVal;

  if (yieldTotal !== 100) {
    alert('‚ö†Ô∏è –°—É–º–º–∞ Yield Zone –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%!\n\n–°–µ–π—á–∞—Å: ' + yieldTotal + '%');
    return;
  }

  // Parameters
  const total = +document.getElementById('totalPortfolio').value;
  const sliderVal = +document.getElementById('growthSlider').value;
  const growthPct = (100 - sliderVal) / 100;
  const stabilityPct = sliderVal / 100;
  const btcStart = +document.getElementById('btcPrice').value;
  const initLTV = +document.getElementById('initLTV').value / 100;
  const liqThresh = +document.getElementById('liqThreshold').value / 100;
  const hfTrigger = +document.getElementById('hfTrigger').value;
  const hfTarget = +document.getElementById('hfTarget').value;
  const gmPct = gmPctVal / 100;
  const clmmPct = clmmPctVal / 100;
  const reservePct = reservePctVal / 100;

  // CLMM range parameters
  const CLMM_LOWER = 0.85; // -15%
  const CLMM_UPPER = 1.05; // +5%

  // Initial state
  const growthZone = total * growthPct;
  let stabilityZone = total * stabilityPct;
  const initialStability = stabilityZone;

  let collateralBTC = growthZone / btcStart;
  const debt = growthZone * initLTV;

  let gmValue = debt * gmPct;
  let reserve = debt * reservePct;

  // CLMM state
  let clmmInitialValue = debt * clmmPct; // Value when position was opened
  let clmmValue = clmmInitialValue;
  let clmmEntryPrice = btcStart;
  let clmmLowerPrice = btcStart * CLMM_LOWER;
  let clmmUpperPrice = btcStart * CLMM_UPPER;
  let clmmNumber = clmmPct > 0 ? 1 : 0; // CLMM#1 if we have CLMM allocation
  let clmmActive = clmmPct > 0;

  // Calculate CLMM BTC when exiting at lower bound
  // BTC = USDC / sqrt(P_entry * P_exit)
  function calcCLMMBtcAtExit(usdcValue, entryPrice, exitPrice) {
    return usdcValue / Math.sqrt(entryPrice * exitPrice);
  }

  // Calculate CLMM value at current price
  function calcCLMMValueAtPrice(initialValue, entryPrice, currentPrice, lowerPrice, upperPrice) {
    if (currentPrice <= lowerPrice) {
      // Fully converted to BTC
      const btcAmount = initialValue / Math.sqrt(entryPrice * lowerPrice);
      return btcAmount * currentPrice;
    } else if (currentPrice >= entryPrice) {
      // At or above entry - value is approximately initial value
      return initialValue;
    } else {
      // Between lower bound and entry price - linear interpolation
      const btcAtLower = initialValue / Math.sqrt(entryPrice * lowerPrice);
      const valueAtLower = btcAtLower * lowerPrice;
      const ratio = (currentPrice - lowerPrice) / (entryPrice - lowerPrice);
      return valueAtLower + (initialValue - valueAtLower) * ratio;
    }
  }

  const results = [];
  let logHTML = '';
  let triggerCount = 0;
  let prevBtcPrice = btcStart;
  let prevGmValue = gmValue;
  let lastTriggerPrice = btcStart;

  // Y/L Ratio: (GM + CLMM + Reserve) / Debt
  function calcYL(gm, clmm, res, debt) {
    return debt > 0 ? (gm + clmm + res) / debt : 0;
  }

  // Simulate with -2% steps from last price until ~70% drop from initial
  let btcPrice = btcStart;
  let stepNum = 0;

  while (true) {
    const dropFromInitial = ((btcPrice - btcStart) / btcStart) * 100;
    const dropFromLast = stepNum === 0 ? 0 : -2;
    const dropFromTrigger = ((btcPrice - lastTriggerPrice) / lastTriggerPrice) * 100;

    // Stop when we reach approximately -70% from initial
    if (dropFromInitial < -70) break;

    let btcAdded = 0;
    let actions = [];
    let isTrigger = false;

    // Recalculate GM value based on price change (AMM formula)
    if (stepNum > 0 && prevGmValue > 0) {
      const gmRatio = Math.sqrt(btcPrice / prevBtcPrice);
      gmValue = prevGmValue * gmRatio;
    }

    // Recalculate CLMM value if active
    if (clmmActive && clmmInitialValue > 0) {
      clmmValue = calcCLMMValueAtPrice(clmmInitialValue, clmmEntryPrice, btcPrice, clmmLowerPrice, clmmUpperPrice);
    }

    // Calculate metrics BEFORE any actions
    const collateralValBefore = collateralBTC * btcPrice;
    const hfBefore = (collateralValBefore * liqThresh) / debt;
    const ylBefore = calcYL(gmValue, clmmValue, reserve, debt);

    // Check if CLMM has exited range (price at or below lower bound)
    const clmmExited = clmmActive && btcPrice <= clmmLowerPrice;

    // Check trigger: HF < trigger threshold
    if (stepNum > 0 && hfBefore < hfTrigger) {

      // Case 1: CLMM is active and has exited - process CLMM exit
      if (clmmActive && clmmExited) {
        isTrigger = true;
        triggerCount++;
        logHTML += '<div class="log-level"><h4>üî¥ –¢—Ä–∏–≥–≥–µ—Ä #' + triggerCount + ' | Drop: ' + fmt(dropFromInitial, 1) + '% | BTC: ' + fmtUSD(btcPrice) + ' | HF: ' + fmt(hfBefore, 2) + '</h4>';

        // CLMM exited at lower bound - convert to BTC using initial value
        const clmmBtc = calcCLMMBtcAtExit(clmmInitialValue, clmmEntryPrice, clmmLowerPrice);
        btcAdded += clmmBtc;

        logHTML += '<div class="log-step">1. CLMM#' + clmmNumber + ' –≤—ã—à–ª–∞ –ø–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ</div>';
        logHTML += '<div class="log-calc">‚Ä¢ CLMM (' + fmtUSD(clmmInitialValue) + ') ‚Üí BTC: ' + fmt(clmmBtc, 6) + ' BTC –≤ –∑–∞–ª–æ–≥</div>';
        actions.push('CLMM#' + clmmNumber + '‚Üí' + fmt(clmmBtc, 4) + ' BTC');

        clmmValue = 0;
        clmmInitialValue = 0;
        clmmActive = false;

        if (triggerCount === 1 && reserve > 0) {
          // Open CLMM#2 from Reserve
          clmmInitialValue = reserve;
          clmmValue = reserve;
          clmmEntryPrice = btcPrice;
          clmmLowerPrice = btcPrice * CLMM_LOWER;
          clmmUpperPrice = btcPrice * CLMM_UPPER;
          clmmNumber = 2;
          clmmActive = true;

          logHTML += '<div class="log-step">2. Reserve ‚Üí CLMM#2: ' + fmtUSD(reserve) + '</div>';
          logHTML += '<div class="log-calc">‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: ' + fmtUSD(clmmLowerPrice) + ' ‚Äî ' + fmtUSD(clmmUpperPrice) + '</div>';
          actions.push('Reserve‚ÜíCLMM#2');

          reserve = 0;
        } else if (triggerCount === 2) {
          logHTML += '<div class="log-step" style="color:#ffaa00">2. –ù–æ–≤—É—é CLMM –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º (Reserve –∏—Å—á–µ—Ä–ø–∞–Ω)</div>';
          actions.push('CLMM STOP');
        }

        // Update collateral
        collateralBTC += btcAdded;
        logHTML += '<div class="log-step">–†–µ–∑—É–ª—å—Ç–∞—Ç: Collateral +' + fmt(btcAdded, 6) + ' BTC ‚Üí ' + fmt(collateralBTC, 4) + ' BTC</div>';
        logHTML += '</div>';
        lastTriggerPrice = btcPrice;
      }
      // Case 2: CLMM is active but hasn't exited yet - wait
      else if (clmmActive && !clmmExited) {
        // HF is low but CLMM hasn't hit lower bound yet - just wait
        actions.push('HF –Ω–∏–∑–∫–∏–π, –∂–¥—ë–º CLMM');
      }
      // Case 3: CLMM is not active (already processed) - sell GM
      else if (!clmmActive) {
        isTrigger = true;
        triggerCount++;
        logHTML += '<div class="log-level"><h4>üî¥ –¢—Ä–∏–≥–≥–µ—Ä #' + triggerCount + ' | Drop: ' + fmt(dropFromInitial, 1) + '% | BTC: ' + fmtUSD(btcPrice) + ' | HF: ' + fmt(hfBefore, 2) + '</h4>';

        // Calculate how much collateral value needed to reach target HF
        const collateralNeeded = hfTarget * debt / liqThresh;
        const usdcNeeded = collateralNeeded - collateralValBefore;

        if (usdcNeeded > 0 && gmValue > 0) {
          // Sell GM: 50% becomes BTC, 50% stays USDC
          const gmToSell = Math.min(gmValue, usdcNeeded * 2);
          const btcFromGM = (gmToSell / 2) / btcPrice;
          const usdcFromGM = gmToSell / 2;

          gmValue -= gmToSell;
          btcAdded += btcFromGM;

          logHTML += '<div class="log-step">1. GM –ø—Ä–æ–¥–∞–∂–∞: ' + fmtUSD(gmToSell) + '</div>';
          logHTML += '<div class="log-calc">‚Ä¢ 50% ‚Üí BTC: ' + fmt(btcFromGM, 6) + ' BTC –≤ –∑–∞–ª–æ–≥</div>';
          logHTML += '<div class="log-calc">‚Ä¢ 50% ‚Üí USDC: ' + fmtUSD(usdcFromGM) + '</div>';
          actions.push('GM‚Üí' + fmt(btcFromGM, 4) + ' BTC');

          // Buy new GM from Stability based on trigger number
          let fundsForGM = usdcFromGM;
          let stabilityUsed = 0;

          if (triggerCount === 3 && stabilityZone > 0) {
            stabilityUsed = stabilityZone / 3;
            fundsForGM += stabilityUsed;
            stabilityZone -= stabilityUsed;
            logHTML += '<div class="log-step">2. Stability 1/3 ‚Üí GM: ' + fmtUSD(stabilityUsed) + '</div>';
            actions.push('Stab 1/3‚ÜíGM');
          } else if (triggerCount === 4 && stabilityZone > 0) {
            stabilityUsed = stabilityZone / 2;
            fundsForGM += stabilityUsed;
            stabilityZone -= stabilityUsed;
            logHTML += '<div class="log-step">2. Stability 1/2 ‚Üí GM: ' + fmtUSD(stabilityUsed) + '</div>';
            actions.push('Stab 1/2‚ÜíGM');
          } else if (triggerCount === 5 && stabilityZone > 0) {
            stabilityUsed = stabilityZone;
            fundsForGM += stabilityUsed;
            stabilityZone = 0;
            logHTML += '<div class="log-step">2. Stability –í–°–Ø ‚Üí GM: ' + fmtUSD(stabilityUsed) + '</div>';
            actions.push('Stab ALL‚ÜíGM');
          } else {
            logHTML += '<div class="log-step" style="color:#ffaa00">2. Stability –∏—Å—á–µ—Ä–ø–∞–Ω–∞</div>';
          }

          if (fundsForGM > 0) {
            gmValue += fundsForGM;
            logHTML += '<div class="log-calc">‚Ä¢ –ò—Ç–æ–≥–æ –≤ GM: ' + fmtUSD(fundsForGM) + '</div>';
          }
        } else if (gmValue <= 0) {
          logHTML += '<div class="log-step" style="color:#ff4444">GM –∏—Å—á–µ—Ä–ø–∞–Ω!</div>';
          actions.push('GM –∏—Å—á–µ—Ä–ø–∞–Ω');
        }

        // Update collateral
        collateralBTC += btcAdded;
        logHTML += '<div class="log-step">–†–µ–∑—É–ª—å—Ç–∞—Ç: Collateral +' + fmt(btcAdded, 6) + ' BTC ‚Üí ' + fmt(collateralBTC, 4) + ' BTC</div>';
        logHTML += '</div>';
        lastTriggerPrice = btcPrice;
      }
    } else if (stepNum === 0) {
      actions.push('–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
    }

    // Calculate metrics AFTER actions
    const collateralValAfter = collateralBTC * btcPrice;
    const hfAfter = (collateralValAfter * liqThresh) / debt;
    const ltvAfter = (debt / collateralValAfter) * 100;
    const ylAfter = calcYL(gmValue, clmmValue, reserve, debt);

    results.push({
      dropInit: dropFromInitial,
      dropLast: dropFromLast,
      dropTrig: dropFromTrigger,
      btcPrice,
      hfBefore,
      hfAfter,
      ltv: ltvAfter,
      collateralBTC,
      collateralVal: collateralValAfter,
      gmValue,
      clmmValue,
      clmmNumber: clmmActive ? clmmNumber : 0,
      btcAdded,
      reserve,
      stabilityZone,
      ylAfter,
      actions: actions.join('; ') || '-',
      isTrigger
    });

    prevBtcPrice = btcPrice;
    prevGmValue = gmValue;

    // Advance to next step: -2% from current price
    btcPrice = btcPrice * 0.98;
    stepNum++;
  }

  renderTable(results);
  document.getElementById('logContainer').innerHTML = logHTML || '<div style="color:#888;padding:20px;text-align:center">–¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ (HF –Ω–µ –æ–ø—É—Å–∫–∞–ª—Å—è –Ω–∏–∂–µ ' + hfTrigger + ')</div>';
  renderCharts(results);
  renderSummary(results, triggerCount);
}

function renderTable(data) {
  const tbody = document.querySelector('#resultsTable tbody');
  tbody.innerHTML = data.map(r => {
    const hfBeforeC = r.hfBefore > 1.5 ? 'positive' : r.hfBefore > 1.2 ? 'warning' : 'danger';
    const hfAfterC = r.hfAfter > 1.5 ? 'positive' : r.hfAfter > 1.2 ? 'warning' : 'danger';
    const ltvC = r.ltv > 75 ? 'danger' : r.ltv > 65 ? 'warning' : '';
    const ylC = r.ylAfter < 0.5 ? 'danger' : r.ylAfter < 0.8 ? 'warning' : '';
    const rowClass = r.isTrigger ? 'trigger-row' : '';

    return '<tr class="' + rowClass + '">' +
      '<td><b>' + fmt(r.dropInit, 1) + '%</b></td>' +
      '<td>' + (r.dropLast === 0 ? '-' : r.dropLast + '%') + '</td>' +
      '<td>' + (r.dropTrig === 0 ? '-' : fmt(r.dropTrig, 1) + '%') + '</td>' +
      '<td>' + fmtUSD(r.btcPrice) + '</td>' +
      '<td class="' + hfBeforeC + '">' + fmt(r.hfBefore, 2) + '</td>' +
      '<td class="' + hfAfterC + '"><b>' + fmt(r.hfAfter, 2) + '</b></td>' +
      '<td class="' + ltvC + '">' + fmt(r.ltv, 1) + '%</td>' +
      '<td><b>' + fmt(r.collateralBTC, 4) + '</b></td>' +
      '<td>' + fmtUSD(r.gmValue) + '</td>' +
      '<td>' + (r.clmmValue > 0 ? fmtUSD(r.clmmValue) : '-') + '</td>' +
      '<td>' + (r.clmmNumber > 0 ? '#' + r.clmmNumber : '-') + '</td>' +
      '<td>' + fmtUSD(r.reserve) + '</td>' +
      '<td>' + fmtUSD(r.stabilityZone) + '</td>' +
      '<td>' + (r.btcAdded > 0 ? '+' + fmt(r.btcAdded, 4) : '-') + '</td>' +
      '<td class="' + ylC + '">' + fmt(r.ylAfter, 2) + '</td>' +
      '<td class="action-cell">' + r.actions + '</td>' +
      '</tr>';
  }).join('');
}

function renderCharts(data) {
  const labels = data.filter((r, i) => i % 5 === 0 || r.isTrigger).map(r => fmt(r.dropInit, 0) + '%');
  const filteredData = data.filter((r, i) => i % 5 === 0 || r.isTrigger);

  const cfgs = [
    { id: 'hfChart', label: 'Health Factor', data: filteredData.map(r => r.hfAfter), color: '#00ff88', ref: 1.0, refLabel: 'Liquidation' },
    { id: 'ltvChart', label: 'LTV %', data: filteredData.map(r => r.ltv), color: '#ff6b35', ref: 85, refLabel: 'Liq Threshold' },
    { id: 'collateralChart', label: 'Collateral BTC', data: filteredData.map(r => r.collateralBTC), color: '#f7931a' },
    { id: 'yieldChart', label: 'Yield Zone $', data: filteredData.map(r => r.gmValue + r.clmmValue + r.reserve), color: '#9966ff' }
  ];

  cfgs.forEach(c => {
    if (charts[c.id]) charts[c.id].destroy();
    const ctx = document.getElementById(c.id).getContext('2d');
    const datasets = [{
      label: c.label,
      data: c.data,
      borderColor: c.color,
      backgroundColor: c.color + '33',
      fill: true,
      tension: 0.3,
      pointRadius: 4
    }];
    if (c.ref) {
      datasets.push({
        label: c.refLabel,
        data: Array(labels.length).fill(c.ref),
        borderColor: '#ff4444',
        borderDash: [5, 5],
        pointRadius: 0,
        fill: false
      });
    }
    charts[c.id] = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#e0e0e0' } } },
        scales: {
          x: { ticks: { color: '#888' }, grid: { color: '#333' } },
          y: { ticks: { color: '#888' }, grid: { color: '#333' } }
        }
      }
    });
  });
}

function renderSummary(data, triggerCount) {
  const first = data[0];
  const last = data[data.length - 1];
  const btcGain = ((last.collateralBTC - first.collateralBTC) / first.collateralBTC * 100);
  const minHF = Math.min(...data.map(r => r.hfAfter));
  const maxLTV = Math.max(...data.map(r => r.ltv));
  const totalBtcAdded = data.reduce((s, r) => s + r.btcAdded, 0);
  const hfTrigger = +document.getElementById('hfTrigger').value;
  const initialYield = first.gmValue + first.clmmValue + first.reserve;
  const finalYield = last.gmValue + last.clmmValue + last.reserve;

  document.getElementById('summary').innerHTML = `
    <h3>üìä –ò—Ç–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏</h3>
    <div class="summary-grid">
      <div class="summary-item"><div class="value">${triggerCount}</div><div class="label">–¢—Ä–∏–≥–≥–µ—Ä–æ–≤ (HF&lt;${hfTrigger})</div></div>
      <div class="summary-item"><div class="value">${fmt(first.collateralBTC, 4)}</div><div class="label">–ù–∞—á–∞–ª—å–Ω—ã–π BTC</div></div>
      <div class="summary-item"><div class="value">${fmt(last.collateralBTC, 4)}</div><div class="label">–ò—Ç–æ–≥–æ–≤—ã–π BTC</div></div>
      <div class="summary-item"><div class="value positive">+${fmt(btcGain, 1)}%</div><div class="label">–†–æ—Å—Ç –∑–∞–ª–æ–≥–∞</div></div>
      <div class="summary-item"><div class="value">+${fmt(totalBtcAdded, 4)}</div><div class="label">BTC –¥–æ–±–∞–≤–ª–µ–Ω–æ</div></div>
      <div class="summary-item"><div class="value ${minHF < 1.1 ? 'danger' : minHF < 1.3 ? 'warning' : ''}">${fmt(minHF, 2)}</div><div class="label">–ú–∏–Ω. HF</div></div>
      <div class="summary-item"><div class="value ${maxLTV > 80 ? 'danger' : maxLTV > 70 ? 'warning' : ''}">${fmt(maxLTV, 1)}%</div><div class="label">–ú–∞–∫—Å. LTV</div></div>
      <div class="summary-item"><div class="value">${fmtUSD(last.stabilityZone)}</div><div class="label">–û—Å—Ç–∞—Ç–æ–∫ Stability</div></div>
      <div class="summary-item"><div class="value">${fmtUSD(last.gmValue)}</div><div class="label">GM –≤ –∫–æ–Ω—Ü–µ</div></div>
      <div class="summary-item"><div class="value">${fmtUSD(finalYield)}</div><div class="label">Yield Zone –≤ –∫–æ–Ω—Ü–µ</div></div>
    </div>
  `;
}

// Run simulation on page load if already authenticated
document.addEventListener('DOMContentLoaded', function() {
  if (sessionStorage.getItem('cgs_auth') === 'true') {
    document.getElementById('passwordOverlay').style.display = 'none';
    document.getElementById('mainContent').classList.remove('content-hidden');
    runSimulation();
  }
});
</script>
</body>
</html>
