<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Hybrid Model ‚Äî Market Drop Simulation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="shared.css">
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
<div class="password-box">
<h2>üîí Hybrid Model Simulation</h2>
<input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
<button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
<div class="error" id="passwordError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
</div>
</div>

<div class="container content-hidden" id="mainContent">
<h1>üìä Hybrid Model ‚Äî –°–∏–º—É–ª—è—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è —Ä—ã–Ω–∫–∞</h1>

<div class="disclaimer">
‚ö†Ô∏è –≠—Ç–æ —Ç–æ–ª—å–∫–æ <b>—Å–∏–º—É–ª—è—Ü–∏—è</b>. –†–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.<br>
–ù–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ–º–∏—Å—Å–∏–∏, slippage, –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Ä—ã–Ω–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.
</div>

<h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
<div class="params-table">
<table class="input-table">
<tr>
<td><label>–û–±—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å ($)</label><input type="number" id="totalPortfolio" value="100000"></td>
<td><label>–¶–µ–Ω–∞ BTC ($)</label><input type="number" id="btcPrice" value="100000"></td>
</tr>
<tr>
<td><label>Initial LTV (%)</label><input type="number" id="initLTV" value="30"></td>
<td><label>Liq Threshold (%)</label><input type="number" id="liqThreshold" value="85"></td>
</tr>
<tr>
<td><label>CLMM APR (%)</label><input type="number" id="clmmAPR" value="25"></td>
<td><label>Stability APR (%)</label><input type="number" id="stabilityAPR" value="10"></td>
</tr>
</table>

<div class="slider-group">
<div class="slider-header">
<span>Growth Zone: <b id="growthVal">50%</b></span>
<span>Stability Zone: <b id="stabilityVal">50%</b></span>
</div>
<input type="range" id="growthSlider" min="0" max="100" value="50">
<div class="slider-labels"><span>0% Growth</span><span>50/50</span><span>100% Growth</span></div>
</div>

<div class="info-box" style="margin-top:15px">
<h4>üìã –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (¬Ω Stability ‚Üí Yield)</h4>
<div class="distribution">
<div class="zone growth">
<div class="name">Growth Zone</div>
<div class="value" id="distGrowth">50%</div>
<div class="pct">BTC –≤ –∑–∞–ª–æ–≥–µ</div>
</div>
<div class="zone yield">
<div class="name">Yield Zone</div>
<div class="value" id="distYield">25% + Debt</div>
<div class="pct">¬Ω Stability + –ó–∞–π–º ‚Üí CLMM</div>
</div>
<div class="zone stability">
<div class="name">Stability Zone</div>
<div class="value" id="distStability">25%</div>
<div class="pct">–°—Ç–µ–π–±–ª–∫–æ–∏–Ω—ã</div>
</div>
</div>
<p style="font-size:0.85em;color:#888;margin-top:10px">
CLMM —Ä–µ–Ω–∂: <b style="color:#9966ff">+10% / -25%</b> –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
</p>
</div>
</div>

<button id="runBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é</button>

<div class="guide-box">
<h3>üìñ –õ–æ–≥–∏–∫–∞ Hybrid –º–æ–¥–µ–ª–∏</h3>
<table>
<tr><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
<tr><td><b>-25%</b></td><td>CLMM#1 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ BTC ‚Üí –∑–∞–ª–æ–≥. –ó–∞–Ω—è—Ç—å –¥–æ 30% LTV. –í–∑—è—Ç—å –≤—Å—é Stability + –∑–∞–π–º ‚Üí –æ—Ç–∫—Ä—ã—Ç—å CLMM#2</td></tr>
<tr><td><b>-50%</b></td><td>CLMM#2 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ BTC ‚Üí –∑–∞–ª–æ–≥. –ó–∞–Ω—è—Ç—å –¥–æ LTV ~60% (–º–∞–∫—Å). –ó–∞–π–º ‚Üí –æ—Ç–∫—Ä—ã—Ç—å CLMM#3</td></tr>
<tr><td><b>-57.8%</b></td><td>CLMM#3 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ BTC ‚Üí –∑–∞–ª–æ–≥. STOP (–±–æ–ª—å—à–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º)</td></tr>
</table>
<p style="margin-top:10px;font-size:0.85em;color:#888">
üí° –ú–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∂–¥–∞—Ç—å <b>48-72 —á–∞—Å–∞</b> –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
</p>
</div>

<h2>üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π</h2>
<div class="table-wrap">
<table id="resultsTable">
<thead><tr>
<th>Drop</th><th>BTC Price</th><th>Collateral BTC</th><th>Collateral $</th><th>Debt</th>
<th>HF –¥–æ</th><th>HF –ø–æ—Å–ª–µ</th><th>LTV</th>
<th>CLMM $</th><th>Stability $</th>
<th>–î–æ—Ö–æ–¥/–º–µ—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>üí∞ –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–∞</h2>
<div id="incomeSection"></div>

<h2>üìù –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ —Ä–∞—Å—á—ë—Ç–æ–≤</h2>
<div class="log" id="logContainer"></div>

<h2>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h2>
<div class="charts">
<div class="chart-box"><canvas id="hfChart"></canvas></div>
<div class="chart-box"><canvas id="ltvChart"></canvas></div>
<div class="chart-box"><canvas id="collateralChart"></canvas></div>
<div class="chart-box"><canvas id="clmmChart"></canvas></div>
<div class="chart-box"><canvas id="incomeChart"></canvas></div>
<div class="chart-box"><canvas id="stabilityChart"></canvas></div>
</div>

<div class="summary" id="summary"></div>
<div class="version">Hybrid v1.0</div>
</div>

<script src="shared.js"></script>
<script>
// Callback after successful auth
function onAuthSuccess() {
  updateDistributionDisplay();
  runSimulation();
}

// Slider event listener
document.getElementById('growthSlider').addEventListener('input', function(e) {
  updateDistributionDisplay();
});

function updateDistributionDisplay() {
  const sliderVal = +document.getElementById('growthSlider').value;
  const growthPct = sliderVal;
  const totalStabilityPct = 100 - sliderVal;
  const yieldPct = totalStabilityPct / 2;
  const stabilityPct = totalStabilityPct / 2;

  document.getElementById('growthVal').textContent = growthPct + '%';
  document.getElementById('stabilityVal').textContent = totalStabilityPct + '%';
  document.getElementById('distGrowth').textContent = growthPct + '%';
  document.getElementById('distYield').textContent = yieldPct + '% + Debt';
  document.getElementById('distStability').textContent = stabilityPct + '%';
}

document.getElementById('runBtn').addEventListener('click', runSimulation);

function runSimulation() {
  const total = getInputValue('totalPortfolio', 100000);
  const btcStart = getInputValue('btcPrice', 100000);
  const initLTV = getInputValue('initLTV', 30) / 100;
  const liqThresh = getInputValue('liqThreshold', 85) / 100;
  const clmmAPR = getInputValue('clmmAPR', 25) / 100;
  const stabilityAPR = getInputValue('stabilityAPR', 10) / 100;

  // Distribution from slider: Growth%, ¬Ω of rest ‚Üí Yield, ¬Ω of rest ‚Üí Stability
  const sliderVal = +document.getElementById('growthSlider').value;
  const growthPct = sliderVal / 100;
  const totalStabilityPct = (100 - sliderVal) / 100;
  const yieldPct = totalStabilityPct / 2;  // Half of "Stability" goes to Yield
  const stabilityPct = totalStabilityPct / 2;  // Remaining half stays as Stability

  // CLMM range: +10% / -25%
  const clmmUpperPct = 1.10;
  const clmmLowerPct = 0.75;

  // Initial state
  const growthZone = total * growthPct;
  let stabilityZone = total * stabilityPct;
  const initialStability = stabilityZone;

  let collateralBTC = growthZone / btcStart;
  let debt = growthZone * initLTV;

  // Yield Zone = 25% + Debt (–∑–∞–π–º –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ CLMM)
  let clmmValue = total * yieldPct + debt;
  let clmmEntryPrice = btcStart;
  let clmmGeneration = 1;
  let clmmActive = true;

  // Generate drops: 0%, -5%, -10%, ..., -60%
  const drops = [];
  for (let d = 0; d >= -60; d -= 5) {
    drops.push(d);
  }

  const results = [];
  let logHTML = '';

  drops.forEach((drop, i) => {
    const btcPrice = btcStart * (1 + drop / 100);
    let btcAdded = 0;
    let hfBefore = 0;
    let actions = [];
    let newLoan = 0;

    logHTML += '<div class="log-level"><h4>üìç –£—Ä–æ–≤–µ–Ω—å ' + drop + '% | BTC = ' + fmtUSD(btcPrice) + '</h4>';

    if (i === 0) {
      // Initial state
      actions.push('–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
      logHTML += '<div class="log-step">–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</div>';
      logHTML += '<div class="log-calc">‚Ä¢ Growth Zone (' + fmt(growthPct * 100, 0) + '%): ' + fmtUSD(growthZone) + ' = ' + fmt(collateralBTC, 4) + ' BTC</div>';
      logHTML += '<div class="log-calc">‚Ä¢ –ó–∞–π–º (LTV ' + fmt(initLTV * 100, 0) + '%): ' + fmtUSD(debt) + ' ‚Üí CLMM</div>';
      logHTML += '<div class="log-calc log-clmm">‚Ä¢ CLMM #1 (' + fmt(yieldPct * 100, 0) + '% + Debt): ' + fmtUSD(total * yieldPct) + ' + ' + fmtUSD(debt) + ' = ' + fmtUSD(clmmValue) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ CLMM —Ä–µ–Ω–∂: ' + fmtUSD(btcStart * clmmLowerPct) + ' - ' + fmtUSD(btcStart * clmmUpperPct) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ Stability Zone (' + fmt(stabilityPct * 100, 0) + '%): ' + fmtUSD(stabilityZone) + '</div>';
    } else {
      // Calculate CLMM boundaries
      const clmmLower = clmmEntryPrice * clmmLowerPct;
      const clmmUpper = clmmEntryPrice * clmmUpperPct;

      // HF BEFORE any actions
      const collateralValBefore = collateralBTC * btcPrice;
      hfBefore = calcHealthFactor(collateralValBefore, debt, liqThresh);

      // Check if CLMM exits range (price drops below lower bound)
      if (clmmActive && btcPrice <= clmmLower) {
        // CLMM fully converted to BTC
        const clmmBtc = calcCLMMBtc(clmmValue, clmmEntryPrice, clmmLower);
        btcAdded += clmmBtc;

        logHTML += '<div class="log-step log-clmm">1. CLMM #' + clmmGeneration + ' –≤—ã—à–ª–∞ –∑–∞ —Ä–µ–Ω–∂ (‚Üí BTC):</div>';
        logHTML += '<div class="log-calc">‚Ä¢ Entry: ' + fmtUSD(clmmEntryPrice) + ' ‚Üí Exit: ' + fmtUSD(clmmLower) + '</div>';
        logHTML += '<div class="log-calc">‚Ä¢ Avg price: ' + fmtUSD(Math.sqrt(clmmEntryPrice * clmmLower)) + '</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC –ø–æ–ª—É—á–µ–Ω–æ: <span class="log-result">' + fmt(clmmBtc, 6) + '</span></div>';

        actions.push('CLMM #' + clmmGeneration + ' ‚Üí BTC');

        // Add BTC to collateral
        collateralBTC += btcAdded;
        const newCollateralVal = collateralBTC * btcPrice;

        logHTML += '<div class="log-step">2. Collateral: +' + fmt(btcAdded, 6) + ' BTC ‚Üí –ò—Ç–æ–≥–æ: ' + fmt(collateralBTC, 4) + ' BTC</div>';

        // Determine next action based on generation
        if (clmmGeneration === 1) {
          // First cycle: borrow to 30% LTV, take all Stability, open CLMM#2
          const targetLTV = 0.30;
          const maxDebt = newCollateralVal * targetLTV;
          newLoan = maxDebt - debt;

          if (newLoan > 0) {
            debt = maxDebt;
            logHTML += '<div class="log-step">3. –ù–æ–≤—ã–π –∑–∞–π–º –¥–æ LTV 30%: +' + fmtUSD(newLoan) + ' ‚Üí –î–æ–ª–≥: ' + fmtUSD(debt) + '</div>';
            actions.push('–ó–∞–π–º +' + fmtUSD(newLoan));
          }

          // Open new CLMM from Stability + new loan
          const clmmFunding = stabilityZone + newLoan;
          clmmValue = clmmFunding;
          clmmEntryPrice = btcPrice;
          clmmGeneration = 2;

          logHTML += '<div class="log-step log-clmm">4. –û—Ç–∫—Ä—ã–≤–∞–µ–º CLMM #2:</div>';
          logHTML += '<div class="log-calc">‚Ä¢ Stability: ' + fmtUSD(stabilityZone) + ' + –ó–∞–π–º: ' + fmtUSD(newLoan) + ' = ' + fmtUSD(clmmFunding) + '</div>';
          logHTML += '<div class="log-calc">‚Ä¢ –ù–æ–≤—ã–π —Ä–µ–Ω–∂: ' + fmtUSD(btcPrice * clmmLowerPct) + ' - ' + fmtUSD(btcPrice * clmmUpperPct) + '</div>';

          stabilityZone = 0;
          actions.push('Stability ‚Üí CLMM #2');

        } else if (clmmGeneration === 2) {
          // Second cycle: borrow to ~60% LTV, open CLMM#3 from loan only
          const targetLTV = 0.60;
          const maxDebt = newCollateralVal * targetLTV;
          newLoan = maxDebt - debt;

          if (newLoan > 0) {
            debt = maxDebt;
            logHTML += '<div class="log-step">3. –ù–æ–≤—ã–π –∑–∞–π–º –¥–æ LTV ~60%: +' + fmtUSD(newLoan) + ' ‚Üí –î–æ–ª–≥: ' + fmtUSD(debt) + '</div>';
            actions.push('–ó–∞–π–º +' + fmtUSD(newLoan));
          }

          // Open new CLMM from loan
          clmmValue = newLoan;
          clmmEntryPrice = btcPrice;
          clmmGeneration = 3;

          logHTML += '<div class="log-step log-clmm">4. –û—Ç–∫—Ä—ã–≤–∞–µ–º CLMM #3:</div>';
          logHTML += '<div class="log-calc">‚Ä¢ –ò–∑ –∑–∞–π–º–∞: ' + fmtUSD(newLoan) + '</div>';
          logHTML += '<div class="log-calc">‚Ä¢ –ù–æ–≤—ã–π —Ä–µ–Ω–∂: ' + fmtUSD(btcPrice * clmmLowerPct) + ' - ' + fmtUSD(btcPrice * clmmUpperPct) + '</div>';

          actions.push('–ó–∞–π–º ‚Üí CLMM #3');

        } else if (clmmGeneration === 3) {
          // Third cycle: STOP - no more CLMM
          clmmValue = 0;
          clmmActive = false;

          logHTML += '<div class="log-step" style="color:#ff4444">3. STOP ‚Äî CLMM –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º</div>';
          actions.push('CLMM STOP');
        }

        btcAdded = 0; // Already added above

      } else if (clmmActive && clmmValue > 0) {
        // CLMM still inside range - calculate current value
        const clmmBefore = clmmValue;
        clmmValue = calcCLMMValue(clmmBefore, clmmEntryPrice, btcPrice, clmmLower, clmmUpper);
        const clmmChange = ((clmmValue / clmmBefore) - 1) * 100;

        logHTML += '<div class="log-step log-clmm">CLMM #' + clmmGeneration + ' –≤–Ω—É—Ç—Ä–∏ —Ä–µ–Ω–∂–∞:</div>';
        logHTML += '<div class="log-calc">‚Ä¢ –†–µ–Ω–∂: ' + fmtUSD(clmmLower) + ' - ' + fmtUSD(clmmUpper) + '</div>';
        logHTML += '<div class="log-calc">‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: ' + fmtUSD(clmmBefore) + ' ‚Üí <span class="log-result">' + fmtUSD(clmmValue) + '</span> (' + fmt(clmmChange, 1) + '%)</div>';
      } else if (!clmmActive) {
        logHTML += '<div class="log-step" style="color:#888">CLMM –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (STOP)</div>';
      }

      // Add any remaining BTC to collateral
      if (btcAdded > 0) {
        collateralBTC += btcAdded;
        logHTML += '<div class="log-step">Collateral: +' + fmt(btcAdded, 6) + ' BTC ‚Üí –ò—Ç–æ–≥–æ: <span class="log-result">' + fmt(collateralBTC, 4) + ' BTC</span></div>';
      }
    }

    // Calculate final metrics
    const collateralVal = collateralBTC * btcPrice;
    const hf = calcHealthFactor(collateralVal, debt, liqThresh);
    const ltv = calcLTV(debt, collateralVal);

    // hfBefore for initial state = hf
    const hfBeforeFinal = (i === 0) ? hf : hfBefore;

    // Calculate monthly income
    const monthlyClmm = calcMonthlyIncome(clmmValue, clmmAPR);
    const monthlyStability = calcMonthlyIncome(stabilityZone, stabilityAPR);
    const monthlyTotal = monthlyClmm + monthlyStability;

    // Log metrics
    const hfClass = getHFClass(hf);
    const hfBeforeClass = getHFClass(hfBeforeFinal);
    const ltvClass = getLTVClass(ltv);

    if (i > 0) {
      const hfDelta = hf - hfBeforeFinal;
      const hfDeltaStr = hfDelta >= 0 ? '+' + fmt(hfDelta, 2) : fmt(hfDelta, 2);
      const hfDeltaColor = hfDelta >= 0 ? '#00ff88' : '#ff4444';
      logHTML += '<div class="log-step" style="margin-top:10px;padding-top:10px;border-top:1px solid #333">';
      logHTML += '–ú–µ—Ç—Ä–∏–∫–∏: HF –¥–æ = <span class="' + hfBeforeClass + '">' + fmt(hfBeforeFinal, 2) + '</span>';
      logHTML += ' ‚Üí HF –ø–æ—Å–ª–µ = <span class="' + hfClass + '">' + fmt(hf, 2) + '</span>';
      logHTML += ' (<span style="color:' + hfDeltaColor + '">' + hfDeltaStr + '</span>)';
      logHTML += ' | LTV = <span class="' + ltvClass + '">' + fmt(ltv, 1) + '%</span>';
      logHTML += '</div>';
    } else {
      logHTML += '<div class="log-step" style="margin-top:10px;padding-top:10px;border-top:1px solid #333">';
      logHTML += '–ú–µ—Ç—Ä–∏–∫–∏: HF = <span class="' + hfClass + '">' + fmt(hf, 2) + '</span>';
      logHTML += ' | LTV = <span class="' + ltvClass + '">' + fmt(ltv, 1) + '%</span>';
      logHTML += '</div>';
    }

    logHTML += '<div class="log-calc">üí∞ –î–æ—Ö–æ–¥/–º–µ—Å: CLMM ' + fmtUSD(monthlyClmm) + ' + Stability ' + fmtUSD(monthlyStability) + ' = <span class="log-result">' + fmtUSD(monthlyTotal) + '</span></div>';
    logHTML += '</div>';

    results.push({
      drop, btcPrice, collateralBTC, collateralVal, debt,
      hfBefore: hfBeforeFinal, hf, ltv,
      clmmValue, stabilityZone, monthlyIncome: monthlyTotal,
      actions: actions.join('; ') || '-'
    });
  });

  renderTable(results);
  document.getElementById('logContainer').innerHTML = logHTML;
  renderCharts(results);
  renderSummary(results);
  renderIncomeSection(results);
}

function renderTable(data) {
  const tbody = document.querySelector('#resultsTable tbody');
  tbody.innerHTML = data.map(r => {
    const hfBeforeC = getHFClass(r.hfBefore);
    const hfC = getHFClass(r.hf);
    const ltvC = getLTVClass(r.ltv);

    // HF delta
    const hfDelta = r.hf - r.hfBefore;
    const hfDeltaClass = hfDelta > 0 ? 'positive' : hfDelta < 0 ? 'danger' : '';
    const hfDeltaStr = r.drop !== 0 ?
      ' <span class="' + hfDeltaClass + '" style="font-size:0.8em">(' + (hfDelta >= 0 ? '+' : '') + fmt(hfDelta, 2) + ')</span>' : '';

    return '<tr>' +
      '<td><b>' + r.drop + '%</b></td>' +
      '<td>' + fmtUSD(r.btcPrice) + '</td>' +
      '<td><b>' + fmt(r.collateralBTC, 4) + '</b></td>' +
      '<td>' + fmtUSD(r.collateralVal) + '</td>' +
      '<td>' + fmtUSD(r.debt) + '</td>' +
      '<td class="' + hfBeforeC + '">' + fmt(r.hfBefore, 2) + '</td>' +
      '<td class="' + hfC + '"><b>' + fmt(r.hf, 2) + '</b>' + hfDeltaStr + '</td>' +
      '<td class="' + ltvC + '">' + fmt(r.ltv, 1) + '%</td>' +
      '<td>' + fmtUSD(r.clmmValue) + '</td>' +
      '<td>' + fmtUSD(r.stabilityZone) + '</td>' +
      '<td class="positive">' + fmtUSD(r.monthlyIncome) + '</td>' +
      '<td class="action-cell">' + r.actions + '</td>' +
      '</tr>';
  }).join('');
}

function renderCharts(data) {
  const labels = data.map(r => r.drop + '%');

  createCharts([
    { id: 'hfChart', label: 'Health Factor', data: data.map(r => r.hf), color: '#00ff88', refLine: 1.0, refLabel: 'Liquidation' },
    { id: 'ltvChart', label: 'LTV %', data: data.map(r => r.ltv), color: '#ff6b35', refLine: 85, refLabel: 'Liq Threshold' },
    { id: 'collateralChart', label: 'Collateral BTC', data: data.map(r => r.collateralBTC), color: '#f7931a' },
    { id: 'clmmChart', label: 'CLMM Value $', data: data.map(r => r.clmmValue), color: '#9966ff' },
    { id: 'incomeChart', label: 'Monthly Income $', data: data.map(r => r.monthlyIncome), color: '#00d4aa' },
    { id: 'stabilityChart', label: 'Stability Zone $', data: data.map(r => r.stabilityZone), color: '#00d4aa' }
  ], labels);
}

function renderSummary(data) {
  const first = data[0], last = data[data.length - 1];
  const btcGain = ((last.collateralBTC - first.collateralBTC) / first.collateralBTC * 100);
  const minHF = Math.min(...data.map(r => r.hf));
  const maxLTV = Math.max(...data.map(r => r.ltv));
  const avgIncome = data.reduce((s, r) => s + r.monthlyIncome, 0) / data.length;

  document.getElementById('summary').innerHTML = `
    <h3>üìä –ò—Ç–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏</h3>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="value">${fmt(first.collateralBTC, 4)}</div>
        <div class="label">–ù–∞—á–∞–ª—å–Ω—ã–π BTC</div>
      </div>
      <div class="summary-item">
        <div class="value">${fmt(last.collateralBTC, 4)}</div>
        <div class="label">–ò—Ç–æ–≥–æ–≤—ã–π BTC</div>
      </div>
      <div class="summary-item">
        <div class="value positive">+${fmt(btcGain, 1)}%</div>
        <div class="label">–†–æ—Å—Ç –∑–∞–ª–æ–≥–∞</div>
      </div>
      <div class="summary-item">
        <div class="value ${minHF < 1.1 ? 'danger' : minHF < 1.3 ? 'warning' : ''}">${fmt(minHF, 2)}</div>
        <div class="label">–ú–∏–Ω. HF</div>
      </div>
      <div class="summary-item">
        <div class="value ${maxLTV > 80 ? 'danger' : maxLTV > 70 ? 'warning' : ''}">${fmt(maxLTV, 1)}%</div>
        <div class="label">–ú–∞–∫—Å. LTV</div>
      </div>
      <div class="summary-item">
        <div class="value">${fmtUSD(avgIncome)}</div>
        <div class="label">–°—Ä–µ–¥. –¥–æ—Ö–æ–¥/–º–µ—Å</div>
      </div>
      <div class="summary-item">
        <div class="value">${fmtUSD(last.clmmValue)}</div>
        <div class="label">CLMM –≤ –∫–æ–Ω—Ü–µ</div>
      </div>
      <div class="summary-item">
        <div class="value">${fmtUSD(last.debt)}</div>
        <div class="label">–î–æ–ª–≥ –≤ –∫–æ–Ω—Ü–µ</div>
      </div>
    </div>
  `;
}

function renderIncomeSection(data) {
  const first = data[0];
  const clmmAPR = getInputValue('clmmAPR', 25);
  const stabilityAPR = getInputValue('stabilityAPR', 10);

  const monthlyClmm = first.clmmValue * clmmAPR / 100 / 12;
  const monthlyStability = first.stabilityZone * stabilityAPR / 100 / 12;
  const monthlyTotal = monthlyClmm + monthlyStability;
  const annualTotal = monthlyTotal * 12;

  document.getElementById('incomeSection').innerHTML = `
    <div class="income-display">
      <div class="amount">${fmtUSD(monthlyTotal)}</div>
      <div class="label">–û–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥ –≤ –º–µ—Å—è—Ü (–ø—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ)</div>
    </div>
    <div class="info-box">
      <h4>üí° –†–∞—Å—á—ë—Ç –¥–æ—Ö–æ–¥–∞</h4>
      <table class="guide-box" style="border:none;padding:0;margin:0;background:transparent">
        <tr>
          <td>CLMM –ø–æ–∑–∏—Ü–∏—è (${fmtUSD(first.clmmValue)} √ó ${clmmAPR}% APR)</td>
          <td style="text-align:right;color:#9966ff"><b>${fmtUSD(monthlyClmm)}/–º–µ—Å</b></td>
        </tr>
        <tr>
          <td>Stability Zone (${fmtUSD(first.stabilityZone)} √ó ${stabilityAPR}% APR)</td>
          <td style="text-align:right;color:#00d4aa"><b>${fmtUSD(monthlyStability)}/–º–µ—Å</b></td>
        </tr>
        <tr style="border-top:2px solid #444">
          <td><b>–ò—Ç–æ–≥–æ –≤ –º–µ—Å—è—Ü</b></td>
          <td style="text-align:right;color:#00ff88"><b>${fmtUSD(monthlyTotal)}</b></td>
        </tr>
        <tr>
          <td><b>–ò—Ç–æ–≥–æ –≤ –≥–æ–¥</b></td>
          <td style="text-align:right;color:#00ff88"><b>${fmtUSD(annualTotal)}</b></td>
        </tr>
      </table>
      <p style="font-size:0.85em;color:#888;margin-top:10px">
        ‚ö†Ô∏è –î–æ—Ö–æ–¥ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã BTC –∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ –ø–æ–∑–∏—Ü–∏–π
      </p>
    </div>
  `;
}
</script>
</body>
</html>
