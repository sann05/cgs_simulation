<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CGS Portfolio Simulation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0f0f23,#1a1a3e);color:#e0e0e0;min-height:100vh;padding:15px}
.password-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0f0f23,#1a1a3e);display:flex;align-items:center;justify-content:center;z-index:9999}
.password-box{background:#1a1a4a;padding:40px;border-radius:16px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.password-box h2{color:#f7931a;margin-bottom:20px}
.password-box input{background:#2a2a5a;border:2px solid #444;color:#fff;padding:12px 20px;border-radius:8px;font-size:1em;width:250px;text-align:center}
.password-box input:focus{outline:none;border-color:#f7931a}
.password-box button{background:linear-gradient(90deg,#f7931a,#ff6b35);color:#fff;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1em;font-weight:bold;margin-top:15px;display:block;width:100%}
.password-box .error{color:#ff4444;font-size:0.85em;margin-top:10px;display:none}
.content-hidden{display:none}
.container{max-width:1500px;margin:0 auto}
h1{text-align:center;color:#f7931a;margin-bottom:8px;font-size:1.6em}
h2{color:#00d4aa;margin:20px 0 12px;font-size:1.2em;border-bottom:2px solid #00d4aa;padding-bottom:6px}
.formula-box{background:#1a1a4a;padding:15px;border-radius:10px;margin:15px 0;text-align:center}
.formula-box .main{color:#f7931a;font-family:monospace;font-size:1.1em}
.params-table{background:#1e1e3f;padding:20px;border-radius:10px;margin-bottom:20px}
.input-table{width:100%;border-collapse:collapse}
.input-table td{padding:10px;width:50%}
.input-table label{display:block;font-size:0.85em;color:#888;margin-bottom:6px}
.input-table input[type="number"]{width:100%;background:#2a2a5a;border:1px solid #444;color:#fff;padding:10px;border-radius:6px;font-size:1em}
.input-table input:focus{outline:none;border-color:#f7931a}
.slider-group{margin:20px 0;padding:15px;background:#1a1a4a;border-radius:8px}
.slider-header{display:flex;justify-content:space-between;margin-bottom:10px;font-size:0.95em}
.slider-header b{color:#f7931a}
.slider-group input[type="range"]{width:100%;height:8px;-webkit-appearance:none;background:linear-gradient(90deg,#f7931a,#00d4aa);border-radius:4px;cursor:pointer}
.slider-group input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:#fff;border-radius:50%;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.slider-labels{display:flex;justify-content:space-between;font-size:0.75em;color:#666;margin-top:5px}
button{background:linear-gradient(90deg,#f7931a,#ff6b35);color:#fff;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1em;font-weight:bold;margin:10px auto;display:block}
.table-wrap{overflow-x:auto;margin-bottom:20px}
table{width:100%;border-collapse:collapse;background:#1a1a3a;border-radius:8px;overflow:hidden;font-size:0.78em}
th{background:#2d2d6a;color:#f7931a;padding:10px 5px;text-align:center;font-weight:600;white-space:nowrap}
td{padding:8px 5px;text-align:center;border-bottom:1px solid #333}
tr:nth-child(even){background:#1e1e4a}
tr:hover{background:#2a2a6a}
.positive{color:#00ff88}
.warning{color:#ffaa00}
.danger{color:#ff4444}
.action-cell{text-align:left !important;font-size:0.9em;max-width:200px}
.log{background:#0a0a1a;padding:15px;border-radius:10px;margin:15px 0;max-height:500px;overflow-y:auto;font-family:monospace;font-size:0.8em;line-height:1.5}
.log-level{border-left:4px solid #f7931a;padding:10px;margin:10px 0;background:#0f0f2a}
.log-level h4{color:#f7931a;margin-bottom:8px}
.log-step{color:#00d4aa;margin:5px 0}
.log-calc{color:#888;margin-left:15px}
.log-result{color:#00ff88;font-weight:bold}
.charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:15px;margin-top:20px}
.chart-box{background:#1a1a3a;padding:12px;border-radius:10px}
.summary{background:linear-gradient(135deg,#1e3a5f,#2a2a5a);padding:15px;border-radius:10px;margin-top:20px}
.summary h3{color:#00d4aa;margin-bottom:12px}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.summary-item{text-align:center;padding:12px;background:#1a1a4a;border-radius:8px}
.summary-item .value{font-size:1.2em;font-weight:bold;color:#f7931a}
.summary-item .label{font-size:0.7em;color:#888;margin-top:4px}
.version{text-align:center;color:#444;font-size:0.7em;margin-top:30px;padding:10px}
</style>
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
<div class="password-box">
<h2>üîí Capital Growth Strategy</h2>
<input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" onkeypress="if(event.key==='Enter')checkPassword()">
<button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
<div class="error" id="passwordError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
</div>
</div>

<div class="container content-hidden" id="mainContent">
<h1>üìä Capital Growth Strategy ‚Äî –°–∏–º—É–ª—è—Ü–∏—è</h1>

<div class="formula-box">
<div class="main">GM_new = GM_old √ó ‚àö(P_new / P_old)</div>
<div style="margin-top:8px;color:#888">–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ GM: 50% ‚Üí BTC (–≤ –∑–∞–ª–æ–≥), 50% ‚Üí USDC (+ Stability ‚Üí –Ω–æ–≤—ã–µ GM)</div>
</div>

<h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
<div class="params-table">
<table class="input-table">
<tr>
<td><label>–û–±—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å ($)</label><input type="number" id="totalPortfolio" value="100000"></td>
<td><label>–¶–µ–Ω–∞ BTC ($)</label><input type="number" id="btcPrice" value="100000"></td>
</tr>
<tr>
<td><label>Initial LTV (%)</label><input type="number" id="initLTV" value="50"></td>
<td><label>Liq Threshold (%)</label><input type="number" id="liqThreshold" value="85"></td>
</tr>
</table>

<div class="slider-group">
<div class="slider-header">
<span>Growth Zone: <b id="growthVal">60%</b></span>
<span>Stability Zone: <b id="stabilityVal">40%</b></span>
</div>
<input type="range" id="growthSlider" min="0" max="100" value="40">
<div class="slider-labels"><span>0%</span><span>50%</span><span>100%</span></div>
</div>

<div class="slider-group">
<div class="slider-header">
<span>GM Pool: <b id="gmPoolVal">70%</b></span>
<span>Reserve: <b id="reserveVal">30%</b></span>
</div>
<input type="range" id="gmPoolSlider" min="0" max="100" value="30">
<div class="slider-labels"><span>0%</span><span>50%</span><span>100%</span></div>
</div>
</div>

<button id="runBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é</button>

<h2>üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π</h2>
<div class="table-wrap">
<table id="resultsTable">
<thead><tr>
<th>Drop</th><th>BTC Price</th><th>Collateral BTC</th><th>Collateral $</th><th>Debt</th><th>HF</th><th>LTV</th><th>GM (–¥–æ)</th><th>BTC –∏–∑ GM</th><th>USDC‚ÜíGM</th><th>GM (–ø–æ—Å–ª–µ)</th><th>Reserve</th><th>Stability</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
</tr></thead>
<tbody></tbody>
</table>
</div>

<h2>üìù –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ —Ä–∞—Å—á—ë—Ç–æ–≤</h2>
<div class="log" id="logContainer"></div>

<h2>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h2>
<div class="charts">
<div class="chart-box"><canvas id="hfChart"></canvas></div>
<div class="chart-box"><canvas id="ltvChart"></canvas></div>
<div class="chart-box"><canvas id="collateralChart"></canvas></div>
<div class="chart-box"><canvas id="stabilityChart"></canvas></div>
<div class="chart-box"><canvas id="gmChart"></canvas></div>
</div>

<div class="summary" id="summary"></div>
<div class="version">v3.3</div>
</div>

<script>
// ===== PASSWORD PROTECTION =====
const PASS_HASH = '5e884898da28047d9169e1809a5f9d4c3f5c7d8a'; // SHA1 of 'password' - CHANGE THIS!

function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(16);
}

function checkPassword() {
  const input = document.getElementById('passwordInput').value;
  const hash = simpleHash(input);
  
  // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∑–∞–º–µ–Ω–∏ 'cgs2024' –Ω–∞ —Å–≤–æ–π –ø–∞—Ä–æ–ª—å
  if (input === 'web3academy_cgs_2025') {
    document.getElementById('passwordOverlay').style.display = 'none';
    document.getElementById('mainContent').classList.remove('content-hidden');
    sessionStorage.setItem('cgs_auth', 'true');
    if (sessionStorage.getItem('cgs_auth') === 'true') {
  runSimulation();
}
  } else {
    document.getElementById('passwordError').style.display = 'block';
    document.getElementById('passwordInput').value = '';
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (sessionStorage.getItem('cgs_auth') === 'true') {
  document.getElementById('passwordOverlay').style.display = 'none';
  document.getElementById('mainContent').classList.remove('content-hidden');
}
// ===== END PASSWORD PROTECTION =====
let charts = {};
const fmt = (n,d=2) => n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});
const fmtUSD = n => '$'+n.toLocaleString(undefined,{maximumFractionDigits:0});

document.getElementById('growthSlider').addEventListener('input', function(e) {
  const val = e.target.value;
  document.getElementById('growthVal').textContent = (100 - val) + '%';
  document.getElementById('stabilityVal').textContent = val + '%';
});

document.getElementById('gmPoolSlider').addEventListener('input', function(e) {
  const val = e.target.value;
  document.getElementById('gmPoolVal').textContent = (100 - val) + '%';
  document.getElementById('reserveVal').textContent = val + '%';
});

document.getElementById('runBtn').addEventListener('click', runSimulation);

function runSimulation() {
  const total = +document.getElementById('totalPortfolio').value;
  const sliderVal = +document.getElementById('growthSlider').value;
  const growthPct = (100 - sliderVal) / 100;
  const stabilityPct = sliderVal / 100;
  const btcStart = +document.getElementById('btcPrice').value;
  const initLTV = +document.getElementById('initLTV').value / 100;
  const liqThresh = +document.getElementById('liqThreshold').value / 100;
  const gmSliderVal = +document.getElementById('gmPoolSlider').value;
  const gmPoolPct = (100 - gmSliderVal) / 100;
  const resPct = gmSliderVal / 100;

  const growthZone = total * growthPct;
  let stabilityZone = total * stabilityPct;
  const initialStability = stabilityZone;
  
  let collateralBTC = growthZone / btcStart;
  const debt = growthZone * initLTV;
  
  let gmValue = debt * gmPoolPct;
  let reserve = debt * resPct;

  const drops = [0, -7, -15, -25, -40, -50, -60, -70];
  const results = [];
  let logHTML = '';

  let prevBtcPrice = btcStart;
  let prevGmValue = gmValue;

  drops.forEach((drop, i) => {
    const btcPrice = btcStart * (1 + drop / 100);
    
    let gmBefore = 0;
    let btcAdded = 0;
    let usdcToGM = 0;
    let stabilityUsed = 0;
    let reserveUsed = 0;
    let gmAfter = 0;
    let action = '';
    
    logHTML += '<div class="log-level"><h4>üìç –£—Ä–æ–≤–µ–Ω—å ' + drop + '% | BTC = ' + fmtUSD(btcPrice) + '</h4>';

    if (i === 0) {
      action = '–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ';
      gmAfter = gmValue;
      logHTML += '<div class="log-step">–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</div>';
      logHTML += '<div class="log-calc">‚Ä¢ Collateral: ' + fmt(collateralBTC,4) + ' BTC = ' + fmtUSD(growthZone) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ –ó–∞–π–º (LTV ' + (initLTV*100) + '%): ' + fmtUSD(debt) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ GM Pool (' + (gmPoolPct*100) + '%): ' + fmtUSD(gmValue) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ Reserve (' + (resPct*100) + '%): ' + fmtUSD(reserve) + '</div>';
      logHTML += '<div class="log-calc">‚Ä¢ Stability Zone: ' + fmtUSD(stabilityZone) + '</div>';
    } 
    else {
      const ratio = Math.sqrt(btcPrice / prevBtcPrice);
      gmBefore = prevGmValue * ratio;
      
      logHTML += '<div class="log-step">1. –ü–µ—Ä–µ—Å—á—ë—Ç GM:</div>';
      logHTML += '<div class="log-calc">' + fmtUSD(prevGmValue) + ' √ó ‚àö(' + fmt(btcPrice) + '/' + fmt(prevBtcPrice) + ') = ' + fmtUSD(prevGmValue) + ' √ó ' + fmt(ratio,4) + ' = <span class="log-result">' + fmtUSD(gmBefore) + '</span></div>';

      if (drop === -7) {
        action = '–ü—Ä–æ–¥–∞—Ç—å 30% GM';
        const sellGM = gmBefore * 0.3;
        const btcFromSell = (sellGM / 2) / btcPrice;
        const usdcFromSell = sellGM / 2;
        
        btcAdded = btcFromSell;
        usdcToGM = usdcFromSell;
        gmAfter = gmBefore * 0.7 + usdcToGM;
        
        logHTML += '<div class="log-step">2. –ü—Ä–æ–¥–∞—ë–º 30% GM = ' + fmtUSD(sellGM) + ':</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC: ' + fmtUSD(sellGM/2) + ' / ' + fmtUSD(btcPrice) + ' = <span class="log-result">' + fmt(btcFromSell,6) + ' BTC</span></div>';
        logHTML += '<div class="log-calc">‚Ä¢ USDC: <span class="log-result">' + fmtUSD(usdcFromSell) + '</span> ‚Üí –ø–æ–∫—É–ø–∞–µ–º GM</div>';
        logHTML += '<div class="log-step">3. GM –ø–æ—Å–ª–µ: ' + fmtUSD(gmBefore*0.7) + ' + ' + fmtUSD(usdcToGM) + ' = <span class="log-result">' + fmtUSD(gmAfter) + '</span></div>';
      }
      else if (drop === -15) {
        action = '–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ GM + Reserve‚ÜíGM';
        const sellGM = gmBefore;
        const btcFromSell = (sellGM / 2) / btcPrice;
        const usdcFromSell = sellGM / 2;
        
        btcAdded = btcFromSell;
        reserveUsed = reserve;
        usdcToGM = usdcFromSell + reserveUsed;
        gmAfter = usdcToGM;
        reserve = 0;
        
        logHTML += '<div class="log-step">2. –ü—Ä–æ–¥–∞—ë–º –í–°–ï GM = ' + fmtUSD(sellGM) + ':</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC: ' + fmtUSD(sellGM/2) + ' / ' + fmtUSD(btcPrice) + ' = <span class="log-result">' + fmt(btcFromSell,6) + ' BTC</span></div>';
        logHTML += '<div class="log-calc">‚Ä¢ USDC –∏–∑ GM: ' + fmtUSD(usdcFromSell) + '</div>';
        logHTML += '<div class="log-step">3. Reserve ‚Üí GM: ' + fmtUSD(reserveUsed) + '</div>';
        logHTML += '<div class="log-step">4. –ü–æ–∫—É–ø–∞–µ–º GM: ' + fmtUSD(usdcFromSell) + ' + ' + fmtUSD(reserveUsed) + ' = <span class="log-result">' + fmtUSD(gmAfter) + '</span></div>';
      }
      else if (drop === -25) {
        action = '–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ GM + 30% Stability';
        const sellGM = gmBefore;
        const btcFromSell = (sellGM / 2) / btcPrice;
        const usdcFromSell = sellGM / 2;
        
        btcAdded = btcFromSell;
        stabilityUsed = initialStability * 0.3;
        usdcToGM = usdcFromSell + stabilityUsed;
        gmAfter = usdcToGM;
        stabilityZone -= stabilityUsed;
        
        logHTML += '<div class="log-step">2. –ü—Ä–æ–¥–∞—ë–º –í–°–ï GM = ' + fmtUSD(sellGM) + ':</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC: ' + fmtUSD(sellGM/2) + ' / ' + fmtUSD(btcPrice) + ' = <span class="log-result">' + fmt(btcFromSell,6) + ' BTC</span></div>';
        logHTML += '<div class="log-calc">‚Ä¢ USDC –∏–∑ GM: ' + fmtUSD(usdcFromSell) + '</div>';
        logHTML += '<div class="log-step">3. Stability 30%: ' + fmtUSD(stabilityUsed) + '</div>';
        logHTML += '<div class="log-step">4. –ü–æ–∫—É–ø–∞–µ–º GM: ' + fmtUSD(usdcFromSell) + ' + ' + fmtUSD(stabilityUsed) + ' = <span class="log-result">' + fmtUSD(gmAfter) + '</span></div>';
      }
      else if (drop === -40) {
        action = '–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ GM + 40% Stability';
        const sellGM = gmBefore;
        const btcFromSell = (sellGM / 2) / btcPrice;
        const usdcFromSell = sellGM / 2;
        
        btcAdded = btcFromSell;
        stabilityUsed = initialStability * 0.4;
        usdcToGM = usdcFromSell + stabilityUsed;
        gmAfter = usdcToGM;
        stabilityZone -= stabilityUsed;
        
        logHTML += '<div class="log-step">2. –ü—Ä–æ–¥–∞—ë–º –í–°–ï GM = ' + fmtUSD(sellGM) + ':</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC: ' + fmtUSD(sellGM/2) + ' / ' + fmtUSD(btcPrice) + ' = <span class="log-result">' + fmt(btcFromSell,6) + ' BTC</span></div>';
        logHTML += '<div class="log-calc">‚Ä¢ USDC –∏–∑ GM: ' + fmtUSD(usdcFromSell) + '</div>';
        logHTML += '<div class="log-step">3. Stability 40%: ' + fmtUSD(stabilityUsed) + '</div>';
        logHTML += '<div class="log-step">4. –ü–æ–∫—É–ø–∞–µ–º GM: ' + fmtUSD(usdcFromSell) + ' + ' + fmtUSD(stabilityUsed) + ' = <span class="log-result">' + fmtUSD(gmAfter) + '</span></div>';
      }
      else if (drop === -50) {
        action = '–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ GM + 30% Stability';
        const sellGM = gmBefore;
        const btcFromSell = (sellGM / 2) / btcPrice;
        const usdcFromSell = sellGM / 2;
        
        btcAdded = btcFromSell;
        stabilityUsed = initialStability * 0.3;
        usdcToGM = usdcFromSell + stabilityUsed;
        gmAfter = usdcToGM;
        stabilityZone -= stabilityUsed;
        
        logHTML += '<div class="log-step">2. –ü—Ä–æ–¥–∞—ë–º –í–°–ï GM = ' + fmtUSD(sellGM) + ':</div>';
        logHTML += '<div class="log-calc">‚Ä¢ BTC: ' + fmtUSD(sellGM/2) + ' / ' + fmtUSD(btcPrice) + ' = <span class="log-result">' + fmt(btcFromSell,6) + ' BTC</span></div>';
        logHTML += '<div class="log-calc">‚Ä¢ USDC –∏–∑ GM: ' + fmtUSD(usdcFromSell) + '</div>';
        logHTML += '<div class="log-step">3. Stability 30%: ' + fmtUSD(stabilityUsed) + '</div>';
        logHTML += '<div class="log-step">4. –ü–æ–∫—É–ø–∞–µ–º GM: ' + fmtUSD(usdcFromSell) + ' + ' + fmtUSD(stabilityUsed) + ' = <span class="log-result">' + fmtUSD(gmAfter) + '</span></div>';
      }
      else {
        action = '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–Ω–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π)';
        gmAfter = gmBefore;
        logHTML += '<div class="log-step">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</div>';
      }

      collateralBTC += btcAdded;
      if (btcAdded > 0) {
        logHTML += '<div class="log-step">5. Collateral: +' + fmt(btcAdded,6) + ' BTC ‚Üí –ò—Ç–æ–≥–æ: <span class="log-result">' + fmt(collateralBTC,4) + ' BTC</span></div>';
      }
    }

    const collateralVal = collateralBTC * btcPrice;
    const hf = (collateralVal * liqThresh) / debt;
    const ltv = (debt / collateralVal) * 100;
    
    const hfClass = hf>1.5 ? 'positive' : hf>1.2 ? 'warning' : 'danger';
    const ltvClass = ltv>75 ? 'danger' : ltv>65 ? 'warning' : '';
    logHTML += '<div class="log-step" style="margin-top:10px;padding-top:10px;border-top:1px solid #333">–ú–µ—Ç—Ä–∏–∫–∏: HF = <span class="' + hfClass + '">' + fmt(hf,2) + '</span> | LTV = <span class="' + ltvClass + '">' + fmt(ltv,1) + '%</span> | Stability = ' + fmtUSD(stabilityZone) + '</div>';
    logHTML += '</div>';

    results.push({
      drop, btcPrice, collateralBTC, collateralVal, debt, hf, ltv,
      gmBefore: i===0 ? gmValue : gmBefore,
      btcAdded, usdcToGM, gmAfter, reserve, stabilityZone, action
    });
    
    prevBtcPrice = btcPrice;
    prevGmValue = gmAfter;
    gmValue = gmAfter;
  });

  renderTable(results);
  document.getElementById('logContainer').innerHTML = logHTML;
  renderCharts(results);
  renderSummary(results);
}

function renderTable(data) {
  const tbody = document.querySelector('#resultsTable tbody');
  tbody.innerHTML = data.map(r => {
    const hfC = r.hf>1.5?'positive':r.hf>1.2?'warning':'danger';
    const ltvC = r.ltv>75?'danger':r.ltv>65?'warning':'';
    return '<tr><td><b>' + r.drop + '%</b></td><td>' + fmtUSD(r.btcPrice) + '</td><td><b>' + fmt(r.collateralBTC,4) + '</b></td><td>' + fmtUSD(r.collateralVal) + '</td><td>' + fmtUSD(r.debt) + '</td><td class="' + hfC + '"><b>' + fmt(r.hf,2) + '</b></td><td class="' + ltvC + '">' + fmt(r.ltv,1) + '%</td><td>' + fmtUSD(r.gmBefore) + '</td><td>' + (r.btcAdded>0?fmt(r.btcAdded,4):'-') + '</td><td>' + (r.usdcToGM>0?fmtUSD(r.usdcToGM):'-') + '</td><td><b>' + fmtUSD(r.gmAfter) + '</b></td><td>' + fmtUSD(r.reserve) + '</td><td>' + fmtUSD(r.stabilityZone) + '</td><td class="action-cell">' + r.action + '</td></tr>';
  }).join('');
}

function renderCharts(data) {
  const labels = data.map(r => r.drop + '%');
  const cfgs = [
    {id:'hfChart',label:'Health Factor',data:data.map(r=>r.hf),color:'#00ff88',ref:1.0,refLabel:'Liquidation'},
    {id:'ltvChart',label:'LTV %',data:data.map(r=>r.ltv),color:'#ff6b35',ref:85,refLabel:'Liq Threshold'},
    {id:'collateralChart',label:'Collateral BTC',data:data.map(r=>r.collateralBTC),color:'#f7931a'},
    {id:'stabilityChart',label:'Stability Zone $',data:data.map(r=>r.stabilityZone),color:'#00d4aa'},
    {id:'gmChart',label:'GM Value $',data:data.map(r=>r.gmAfter),color:'#9966ff'}
  ];
  
  cfgs.forEach(c => {
    if(charts[c.id]) charts[c.id].destroy();
    const ctx = document.getElementById(c.id).getContext('2d');
    const datasets = [{label:c.label,data:c.data,borderColor:c.color,backgroundColor:c.color+'33',fill:true,tension:0.3,pointRadius:5}];
    if(c.ref) datasets.push({label:c.refLabel,data:Array(labels.length).fill(c.ref),borderColor:'#ff4444',borderDash:[5,5],pointRadius:0,fill:false});
    charts[c.id] = new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{labels:{color:'#e0e0e0'}}},scales:{x:{ticks:{color:'#888'},grid:{color:'#333'}},y:{ticks:{color:'#888'},grid:{color:'#333'}}}}});
  });
}

function renderSummary(data) {
  const first = data[0], last = data[data.length-1];
  const btcGain = ((last.collateralBTC - first.collateralBTC) / first.collateralBTC * 100);
  const minHF = Math.min(...data.map(r => r.hf));
  const maxLTV = Math.max(...data.map(r => r.ltv));
  const totalBtcAdded = data.reduce((s,r) => s + r.btcAdded, 0);
  
  document.getElementById('summary').innerHTML = '<h3>üìä –ò—Ç–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏</h3><div class="summary-grid"><div class="summary-item"><div class="value">' + fmt(first.collateralBTC,4) + '</div><div class="label">–ù–∞—á–∞–ª—å–Ω—ã–π BTC</div></div><div class="summary-item"><div class="value">' + fmt(last.collateralBTC,4) + '</div><div class="label">–ò—Ç–æ–≥–æ–≤—ã–π BTC</div></div><div class="summary-item"><div class="value positive">+' + fmt(btcGain,1) + '%</div><div class="label">–†–æ—Å—Ç –∑–∞–ª–æ–≥–∞</div></div><div class="summary-item"><div class="value">+' + fmt(totalBtcAdded,4) + '</div><div class="label">BTC –¥–æ–±–∞–≤–ª–µ–Ω–æ</div></div><div class="summary-item"><div class="value ' + (minHF<1.1?'danger':minHF<1.3?'warning':'') + '">' + fmt(minHF,2) + '</div><div class="label">–ú–∏–Ω. HF</div></div><div class="summary-item"><div class="value ' + (maxLTV>80?'danger':maxLTV>70?'warning':'') + '">' + fmt(maxLTV,1) + '%</div><div class="label">–ú–∞–∫—Å. LTV</div></div><div class="summary-item"><div class="value">' + fmtUSD(last.stabilityZone) + '</div><div class="label">–û—Å—Ç–∞—Ç–æ–∫ Stability</div></div><div class="summary-item"><div class="value">' + fmtUSD(last.gmAfter) + '</div><div class="label">GM –≤ –∫–æ–Ω—Ü–µ</div></div></div>';
}

runSimulation();
</script>
</body>
</html>
